name: Bulk Assign Copilot to All Open Issues

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (only show what would be done)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  bulk-assign:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Bulk assign copilot label to open issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dryRun = '${{ inputs.dry_run }}' === 'true';
            const copilotLabel = 'copilot';
            
            console.log(`üöÄ Starting bulk assignment process (Dry run: ${dryRun})`);
            console.log(`Repository: ${context.repo.owner}/${context.repo.repo}\n`);
            
            // Fetch all open issues
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${issues.length} open items (issues + PRs)\n`);
            
            let updated = 0;
            let alreadyLabeled = 0;
            let skipped = 0;
            
            for (const issue of issues) {
              // Skip pull requests
              if (issue.pull_request) {
                console.log(`  #${issue.number}: Skipping (pull request)`);
                skipped++;
                continue;
              }
              
              // Check if copilot label already exists
              const labels = issue.labels.map(l => l.name);
              const hasCopilotLabel = labels.includes(copilotLabel);
              
              if (hasCopilotLabel) {
                console.log(`  #${issue.number}: Already has '${copilotLabel}' label`);
                alreadyLabeled++;
              } else {
                console.log(`  #${issue.number}: ${dryRun ? '[DRY RUN] Would add' : 'Adding'} '${copilotLabel}' label`);
                console.log(`           Title: "${issue.title}"`);
                
                if (!dryRun) {
                  try {
                    await github.rest.issues.addLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      labels: [copilotLabel]
                    });
                    console.log(`           ‚úÖ Successfully added label`);
                    updated++;
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                  } catch (error) {
                    console.log(`           ‚ùå Failed to add label: ${error.message}`);
                  }
                } else {
                  updated++;
                }
              }
            }
            
            console.log('\nüìä Summary:');
            console.log(`  Total items processed: ${issues.length}`);
            console.log(`  Issues ${dryRun ? 'that would be updated' : 'updated'}: ${updated}`);
            console.log(`  Issues already labeled: ${alreadyLabeled}`);
            console.log(`  Items skipped (PRs): ${skipped}`);
            
            if (!dryRun && updated > 0) {
              console.log('\n‚ú® The auto-assign-copilot.yml workflow will automatically assign');
              console.log('   the Copilot user to issues with the copilot label.');
            }
            
            if (dryRun) {
              console.log('\n‚ö†Ô∏è  This was a DRY RUN. No changes were made.');
              console.log('   Run again with dry_run=false to apply changes.');
            }
