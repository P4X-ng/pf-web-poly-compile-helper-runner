# Exploit Development Tools for pf-runner
# Modern exploit development, ROP chain automation, and binary analysis

# Installation Tasks

task install-checksec
  describe Install checksec binary protection checker
  shell echo "Installing checksec..."
  shell mkdir -p ~/.local/bin
  shell curl -s https://raw.githubusercontent.com/slimm609/checksec.sh/main/checksec -o ~/.local/bin/checksec
  shell chmod +x ~/.local/bin/checksec
  shell echo "✅ checksec installed successfully"
  shell echo "Test with: checksec --version"
end


task install-ropper
  describe Install ropper as alternative ROP tool
  shell echo "Installing ropper..."
  shell pip3 install --user ropper
  shell echo "✅ ropper installed successfully"
  shell echo "Test with: ropper --version"
end

task install-exploit-tools
  describe Install all exploit development tools (pwntools, checksec, ROPgadget, ropper)
  shell echo "╔════════════════════════════════════════════════════════════╗"
  shell echo "║         INSTALLING EXPLOIT DEVELOPMENT TOOLS              ║"
  shell echo "╚════════════════════════════════════════════════════════════╝"
  shell echo ""
  shell pf install-pwntools
  shell echo ""
  shell pf install-checksec
  shell echo ""
  shell pf install-ropgadget
  shell echo ""
  shell pf install-ropper
  shell echo ""
  shell echo "╔════════════════════════════════════════════════════════════╗"
  shell echo "║         ALL EXPLOIT TOOLS INSTALLED                       ║"
  shell echo "╚════════════════════════════════════════════════════════════╝"
end

# Binary Analysis Tasks



task checksec-dir-report
  describe Generate comprehensive security report for directory
  shell mkdir -p ${output_dir:-./checksec_reports}
  shell python3 tools/exploit/checksec_batch.py ${dir:-.} --output ${output_dir:-./checksec_reports}
end

# pwntools Integration Tasks



task pwn-cyclic-find
  describe Find offset in cyclic pattern
  shell python3 -c "import pwn; print('Offset:', pwn.cyclic_find('${pattern}'))"
end


task pwn-asm
  describe Assemble assembly code using pwntools
  shell python3 -c "import pwn; pwn.context.arch='${arch:-amd64}'; print(pwn.asm('${code}').hex())"
end

task pwn-disasm
  describe Disassemble bytecode using pwntools
  shell python3 -c "import pwn; pwn.context.arch='${arch:-amd64}'; print(pwn.disasm(bytes.fromhex('${bytecode}')))"
end

# ROP Chain Automation

task rop-search-gadgets
  describe Search for specific ROP gadgets
  shell ROPgadget --binary ${binary} --only "${gadgets}" ${output:+> $output}
end


task rop-chain-syscall
  describe Build ROP chain for system call
  shell ROPgadget --binary ${binary} --ropchain --badbytes "${badbytes:-00}" ${output:+> $output}
end

task ropper-gadgets
  describe Find gadgets using ropper (alternative to ROPgadget)
  shell ropper --file ${binary} ${type:+--type $type} ${output:+> $output}
end

task ropper-chain
  describe Build ROP chain using ropper
  shell ropper --file ${binary} --chain "${goal:-execve(/bin/sh)}" ${output:+> $output}
end

# Advanced Exploit Development
task exploit-info
  describe Gather comprehensive information about target binary
  shell echo "╔════════════════════════════════════════════════════════════╗"
  shell echo "║         BINARY ANALYSIS REPORT                            ║"
  shell echo "╚════════════════════════════════════════════════════════════╝"
  shell echo ""
  shell echo "[1/4] File information:"
  shell file ${binary}
  shell echo ""
  shell echo "[2/4] Security features:"
  shell pf checksec binary=${binary}
  shell echo ""
  shell echo "[3/4] Strings analysis:"
  shell strings ${binary} | head -20
  shell echo ""
  shell echo "[4/4] Function symbols:"
  shell nm ${binary} 2>/dev/null | grep -E " [TtWw] " | head -10 || objdump -t ${binary} | grep -E "\.text" | head -10
  shell echo ""
  shell echo "Analysis complete. Use 'pf rop-find-gadgets binary=${binary}' for ROP analysis."
end

task exploit-workflow
  describe Complete exploit development workflow
  shell echo "╔════════════════════════════════════════════════════════════╗"
  shell echo "║         EXPLOIT DEVELOPMENT WORKFLOW                      ║"
  shell echo "╚════════════════════════════════════════════════════════════╝"
  shell echo ""
  shell echo "[1/5] Analyzing binary security features..."
  shell pf checksec binary=${binary}
  shell echo ""
  shell echo "[2/5] Generating exploit template..."
  shell pf pwn-template binary=${binary} output=${output:-exploit.py}
  shell echo ""
  shell echo "[3/5] Finding ROP gadgets..."
  shell pf rop-find-gadgets binary=${binary} output=${binary}_gadgets.txt
  shell echo ""
  shell echo "[4/5] Building ROP chain..."
  shell pf rop-chain-build binary=${binary} output=${binary}_ropchain.py
  shell echo ""
  shell echo "[5/5] Generating shellcode..."
  shell pf pwn-shellcode arch=${arch:-amd64} output=${binary}_shellcode.py
  shell echo ""
  shell echo "╔════════════════════════════════════════════════════════════╗"
  shell echo "║         EXPLOIT DEVELOPMENT COMPLETE                      ║"
  shell echo "╚════════════════════════════════════════════════════════════╝"
  shell echo ""
  shell echo "Generated files:"
  shell echo "  - ${output:-exploit.py} (main exploit template)"
  shell echo "  - ${binary}_gadgets.txt (ROP gadgets)"
  shell echo "  - ${binary}_ropchain.py (ROP chain)"
  shell echo "  - ${binary}_shellcode.py (shellcode)"
end

# Buffer Overflow Helpers
task buffer-overflow-pattern
  describe Generate pattern for buffer overflow analysis
  shell python3 -c "import pwn; print(pwn.cyclic(${length:-300}))" ${output:+> $output}
end

task buffer-overflow-offset
  describe Find buffer overflow offset from crash
  shell python3 tools/exploit/offset_finder.py ${crash_value} ${pattern_length:-300}
end

task buffer-overflow-exploit
  describe Generate buffer overflow exploit template
  shell python3 tools/exploit/buffer_overflow_template.py ${binary} ${offset} ${output:-bof_exploit.py}
end

# Format String Helpers
task format-string-test
  describe Test for format string vulnerabilities
  shell python3 tools/exploit/format_string_tester.py ${binary} ${input_method:-stdin}
end

task format-string-exploit
  describe Generate format string exploit template
  shell python3 tools/exploit/format_string_template.py ${binary} ${output:-fmt_exploit.py}
end

# Heap Exploitation Helpers
task heap-info
  describe Analyze heap layout and protections
  shell python3 tools/exploit/heap_analyzer.py ${binary}
end

# Demo and Testing
task exploit-demo
  describe Run exploit development demo with vulnerable binary
  shell echo "Building vulnerable demo binary..."
  shell gcc -o /tmp/vuln_demo -fno-stack-protector -z execstack -no-pie tools/exploit/demo/vulnerable.c
  shell echo "Running exploit workflow on demo binary..."
  shell pf exploit-workflow binary=/tmp/vuln_demo output=demo_exploit.py
  shell echo "Demo complete! Check demo_exploit.py for generated exploit."
end

task exploit-test-tools
  describe Test all exploit development tools
  shell echo "Testing exploit development tools..."
  shell echo ""
  shell echo "1. Testing pwntools..."
  shell python3 -c "import pwn; print('✅ pwntools version:', pwn.__version__)"
  shell echo ""
  shell echo "2. Testing checksec..."
  shell checksec --version
  shell echo ""
  shell echo "3. Testing ROPgadget..."
  shell ROPgadget --version
  shell echo ""
  shell echo "4. Testing ropper..."
  shell ropper --version
  shell echo ""
  shell echo "All tools working correctly! ✅"
end

# Help and Documentation
task exploit-help
  describe Show exploit development commands help
  shell echo "╔════════════════════════════════════════════════════════════╗"
  shell echo "║         EXPLOIT DEVELOPMENT TOOLS HELP                    ║"
  shell echo "╚════════════════════════════════════════════════════════════╝"
  shell echo ""
  shell echo "INSTALLATION:"
  shell echo "  pf install-exploit-tools     # Install all tools"
  shell echo "  pf install-pwntools          # Install pwntools only"
  shell echo "  pf install-checksec          # Install checksec only"
  shell echo "  pf install-ropgadget         # Install ROPgadget only"
  shell echo ""
  shell echo "BINARY ANALYSIS:"
  shell echo "  pf checksec binary=<file>    # Check security features"
  shell echo "  pf exploit-info binary=<file> # Comprehensive analysis"
  shell echo ""
  shell echo "EXPLOIT DEVELOPMENT:"
  shell echo "  pf pwn-template binary=<file> # Generate exploit template"
  shell echo "  pf pwn-cyclic length=200     # Generate cyclic pattern"
  shell echo "  pf pwn-shellcode arch=amd64  # Generate shellcode"
  shell echo ""
  shell echo "ROP CHAIN BUILDING:"
  shell echo "  pf rop-find-gadgets binary=<file> # Find ROP gadgets"
  shell echo "  pf rop-chain-build binary=<file>  # Build ROP chain"
  shell echo ""
  shell echo "COMPLETE WORKFLOWS:"
  shell echo "  pf exploit-workflow binary=<file> # Full exploit development"
  shell echo "  pf exploit-demo               # Run demo with vulnerable binary"
  shell echo ""
  shell echo "TESTING:"
  shell echo "  pf exploit-test-tools         # Test all tools"
  shell echo ""
  shell echo "For more help: https://docs.pwntools.com/"
end