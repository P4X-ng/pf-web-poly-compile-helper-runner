# pf web plugin (minimal)
task web-dev
  shell_lang bash
  shell node tools/static-server.mjs ${dir:-web} ${port:-8080}
end

task web-test
  shell_lang bash
  shell npx playwright test --reporter=list
end

task web-build-rust-wasm
  describe Build Rust to WebAssembly
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/rust && wasm-pack build --target web --out-dir ../web/wasm/rust/pkg --out-name rust_demo
end

task web-build-rust
  describe Build Rust demo (alias for web-build-rust-wasm)
  shell pf web-build-rust-wasm
end

task web-build-rust-llvm
  describe Build Rust to LLVM IR with optimization (opt_level=3 by default, parallel=false)
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/rust && mkdir -p ../web/llvm/rust && rustc --emit=llvm-ir --crate-type=lib -C opt-level=${opt_level:-3} src/lib_simple.rs -o ../web/llvm/rust/lib.ll
end

task web-build-c-wasm
  describe Build C to WebAssembly
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/c && emcc c_trap.c -O0 -sASSERTIONS=1 -sMODULARIZE -sEXPORT_ES6 -sENVIRONMENT=web -sEXPORTED_FUNCTIONS=_trigger_trap,_main -sINVOKE_RUN=0 -o ../web/wasm/c/c_trap.js
end

task web-build-c
  describe Build C demo (alias for web-build-c-wasm)
  shell pf web-build-c-wasm
end

task web-build-c-asm
  describe Build C to asm.js
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/c && emcc c_trap.c -O2 -sWASM=0 -sMODULARIZE -sEXPORT_ES6 -sENVIRONMENT=web -sEXPORTED_FUNCTIONS=_trigger_trap,_main -sINVOKE_RUN=0 -o ../web/asm/c/c_trap_asm.js
end

task web-build-c-llvm
  describe Build C to LLVM IR with optimization (opt_level=3 by default, parallel=false for OpenMP)
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/c && mkdir -p .tmp && echo "#define EMSCRIPTEN_KEEPALIVE" > .tmp/emscripten.h && clang -S -emit-llvm -O${opt_level:-3} ${parallel:+-fopenmp} -I.tmp c_trap.c -o ../web/llvm/c/c_trap.ll && rm -rf .tmp
end

task web-build-fortran-wasm
  describe Build Fortran to WebAssembly
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/fortran && lfortran src/hello.f90 -o ../web/wasm/fortran/fortran.wasm --target=wasm32-unknown-unknown
end

task web-build-fortran
  describe Build Fortran demo (alias for web-build-fortran-wasm)
  shell pf web-build-fortran-wasm
end

task web-build-fortran-llvm
  describe Build Fortran to LLVM IR with optimization (opt_level=3 by default, parallel=false for OpenMP)
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/fortran && lfortran src/hello.f90 --show-llvm -O${opt_level:-3} ${parallel:+-fopenmp} -o ../web/llvm/fortran/hello.ll
end

task web-build-wat-wasm
  describe Build WAT to WebAssembly
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/asm && wat2wasm mini.wat -o ../web/wasm/asm/mini.wasm
end

task web-build-wat
  describe Build WAT demo (alias for web-build-wat-wasm)
  shell pf web-build-wat-wasm
end

task web-build-all
  shell pf web-build-rust
  shell pf web-build-c
  shell pf web-build-fortran
  shell pf web-build-wat
end

task web-build-all-wasm
  describe Build all languages to WebAssembly
  shell pf web-build-rust-wasm
  shell pf web-build-c-wasm
  shell pf web-build-fortran-wasm
  shell pf web-build-wat-wasm
end

task web-build-all-asm
  describe Build all languages to asm.js where supported
  shell pf web-build-c-asm
end

task web-build-all-llvm
  describe Build all languages to LLVM IR where supported (with O3 by default, use opt_level= and parallel=true as needed)
  shell pf web-build-rust-llvm opt_level=${opt_level:-3}
  shell pf web-build-c-llvm opt_level=${opt_level:-3} parallel=${parallel:-false}
  shell pf web-build-fortran-llvm opt_level=${opt_level:-3} parallel=${parallel:-false}
end

task web-build-c-llvm-opt
  describe Build C to LLVM IR with custom optimization passes (passes="pass1,pass2,..." uses new pass manager)
  shell_lang bash
  shell cd demos/pf-web-polyglot-demo-plus-c/c && mkdir -p .tmp ../web/llvm/c && echo "#define EMSCRIPTEN_KEEPALIVE" > .tmp/emscripten.h && clang -S -emit-llvm -O${opt_level:-3} ${parallel:+-fopenmp} -I.tmp c_trap.c -o .tmp/c_trap_unopt.ll && opt-18 -S -passes="${passes:-mem2reg,instcombine,simplifycfg,loop-vectorize}" .tmp/c_trap_unopt.ll -o ../web/llvm/c/c_trap.ll && rm -rf .tmp
end

task install-base
  describe Install base pf runner, Python dependencies, and core build tools
  shell_lang bash
  shell bash install.sh base
end

task install-web
  describe Install web/WASM development tools (Node.js, Playwright, Rust, Emscripten, WABT)
  shell_lang bash
  shell bash install.sh web
end

task install
  describe Install everything - base pf runner and all web/WASM development tools
  shell_lang bash
  shell bash install.sh all
end

task vmkit-swarm-start
  describe Start the VMKit Redis swarm backend
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm start
end

task vmkit-swarm-stop
  describe Stop the VMKit Redis swarm backend
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm stop
end

task vmkit-swarm-status
  describe Show VMKit swarm queue statistics
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm status --redis-url ${redis_url:-redis://127.0.0.1:6379/0}
end

task vmkit-swarm-orchestrate
  describe Run the VMKit swarm orchestrator loop (timeout=0 means infinite)
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm orchestrate --redis-url ${redis_url:-redis://127.0.0.1:6379/0} --timeout ${timeout:-0}
end

task vmkit-swarm-replicator-profiles
  describe List available VMKit Digital Kraken OSv profiles
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm replicator profiles
end

task vmkit-swarm-replicator-build
  describe Build a VMKit Digital Kraken OSv profile (profile=python|cpp|java|rust)
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm replicator build ${profile:-python} ${no_registry_copy:+--no-registry-copy}
end

task vmkit-swarm-replicator-launch
  describe Launch the VMKit Digital Kraken container (toggle replace=true foreground=true attach=false as needed)
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm replicator launch --profile ${profile:-python} --name ${name:-vmkit-kraken} --redis-url ${redis_url:-redis://127.0.0.1:6379/0} --registry-port ${registry_port:-5000} --osv-port ${osv_port:-5500} --max-generations ${max_generations:-5} --replication-rate ${replication_rate:-2} ${replace:+--replace} ${foreground:+--foreground} ${no_attach:+--no-attach}
end

task vmkit-swarm-replicator-stop
  describe Stop the VMKit Digital Kraken container
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm replicator stop --name ${name:-vmkit-kraken}
end

task vmkit-swarm-replicator-status
  describe Show status of the VMKit Digital Kraken container
  shell_lang bash
  shell cd ${vmkit_dir:-../HGWS/VMKit} && vmkit swarm replicator status ${name:+--name ${name}}
end
