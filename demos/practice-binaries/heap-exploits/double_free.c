// Double-Free vulnerability practice binary
// Purpose: Learn double-free exploitation
// Vulnerability: Freeing memory twice

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct {
    char data[48];
    int id;
} Chunk;

Chunk *chunks[10];
int chunk_count = 0;

void admin_shell() {
    printf("\nðŸ† ADMIN SHELL SPAWNED! ðŸ†\n");
    printf("Double-free exploitation successful!\n");
    system("/bin/sh");
}

void create_chunk(char *data) {
    if (chunk_count >= 10) {
        printf("Max chunks reached!\n");
        return;
    }
    
    Chunk *c = (Chunk*)malloc(sizeof(Chunk));
    if (!c) {
        printf("Allocation failed!\n");
        return;
    }
    
    strncpy(c->data, data, sizeof(c->data) - 1);
    c->id = chunk_count;
    chunks[chunk_count] = c;
    
    printf("Created chunk %d at %p\n", chunk_count, (void*)c);
    chunk_count++;
}

void free_chunk(int id) {
    if (id < 0 || id >= chunk_count) {
        printf("Invalid chunk ID!\n");
        return;
    }
    
    if (chunks[id] == NULL) {
        printf("Chunk %d already freed!\n", id);
        // VULNERABILITY: Could still try to free again
    }
    
    printf("Freeing chunk %d at %p\n", id, (void*)chunks[id]);
    free(chunks[id]);
    // VULNERABILITY: Not setting to NULL
}

void edit_chunk(int id, char *data) {
    if (id < 0 || id >= chunk_count) {
        printf("Invalid chunk ID!\n");
        return;
    }
    
    // VULNERABILITY: No check if chunk was freed
    printf("Editing chunk %d at %p\n", id, (void*)chunks[id]);
    strncpy(chunks[id]->data, data, sizeof(chunks[id]->data) - 1);
}

void view_chunk(int id) {
    if (id < 0 || id >= chunk_count) {
        printf("Invalid chunk ID!\n");
        return;
    }
    
    printf("Chunk %d at %p:\n", id, (void*)chunks[id]);
    printf("  ID: %d\n", chunks[id]->id);
    printf("  Data: %s\n", chunks[id]->data);
}

int main(int argc, char *argv[]) {
    printf("=== Double-Free Practice ===\n");
    printf("Admin shell at: %p\n", (void*)admin_shell);
    
    if (argc < 2) {
        printf("\nUsage: %s <command>\n", argv[0]);
        printf("Commands:\n");
        printf("  create <data>     - Create new chunk\n");
        printf("  free <id>         - Free chunk by id\n");
        printf("  edit <id> <data>  - Edit chunk data\n");
        printf("  view <id>         - View chunk contents\n");
        printf("\nPractice objectives:\n");
        printf("1. Create chunks, free one twice (double-free)\n");
        printf("2. Observe heap corruption\n");
        printf("3. Exploit corrupted heap metadata\n");
        printf("4. Control execution flow\n");
        printf("\nExample sequence:\n");
        printf("  create AAAA\n");
        printf("  create BBBB\n");
        printf("  free 0\n");
        printf("  free 0  (double-free!)\n");
        return 1;
    }
    
    if (strcmp(argv[1], "create") == 0 && argc > 2) {
        create_chunk(argv[2]);
    } else if (strcmp(argv[1], "free") == 0 && argc > 2) {
        free_chunk(atoi(argv[2]));
    } else if (strcmp(argv[1], "edit") == 0 && argc > 3) {
        edit_chunk(atoi(argv[2]), argv[3]);
    } else if (strcmp(argv[1], "view") == 0 && argc > 2) {
        view_chunk(atoi(argv[2]));
    }
    
    return 0;
}
