# Makefile for Vulnerable Legacy Service ROP Demo
#
# This builds the vulnerable binary with security features disabled
# to demonstrate ROP exploitation techniques.

CC = gcc
CFLAGS = -g -O0
TARGET = vulnerable_service

# Disable security features for demonstration
# -fno-stack-protector: Disable stack canaries
# -z execstack: Make stack executable (can be removed to demonstrate NX bypass)
# -no-pie: Disable Position Independent Executable (makes addresses predictable)
# -Wno-deprecated-declarations: Suppress warnings for unsafe functions
EXPLOIT_FLAGS = -fno-stack-protector -no-pie -Wno-deprecated-declarations

# For NX demonstration (non-executable stack)
NX_FLAGS = -z noexecstack

all: $(TARGET) $(TARGET)-nx

# Build vulnerable service with executable stack
$(TARGET): vulnerable_service.c
	@echo "[*] Building vulnerable service (executable stack)..."
	$(CC) $(CFLAGS) $(EXPLOIT_FLAGS) -o $@ $<
	@echo "[+] Built: $@"
	@echo "[*] Security features:"
	@echo "    - Stack canaries: DISABLED (-fno-stack-protector)"
	@echo "    - PIE/ASLR: DISABLED (-no-pie)"
	@echo "    - NX bit: DISABLED (executable stack)"

# Build vulnerable service with NX bit (non-executable stack)
$(TARGET)-nx: vulnerable_service.c
	@echo "[*] Building vulnerable service with NX (non-executable stack)..."
	$(CC) $(CFLAGS) $(EXPLOIT_FLAGS) $(NX_FLAGS) -o $@ $<
	@echo "[+] Built: $@"
	@echo "[*] Security features:"
	@echo "    - Stack canaries: DISABLED (-fno-stack-protector)"
	@echo "    - PIE/ASLR: DISABLED (-no-pie)"
	@echo "    - NX bit: ENABLED (non-executable stack) - ROP required!"

# Check security features of the binaries
check: $(TARGET) $(TARGET)-nx
	@echo ""
	@echo "=== Security Analysis ==="
	@echo ""
	@echo "[*] $(TARGET) (executable stack):"
	@if command -v checksec > /dev/null 2>&1; then \
		checksec --file=$(TARGET); \
	else \
		readelf -l $(TARGET) | grep -A 1 GNU_STACK || echo "No GNU_STACK segment"; \
	fi
	@echo ""
	@echo "[*] $(TARGET)-nx (non-executable stack):"
	@if command -v checksec > /dev/null 2>&1; then \
		checksec --file=$(TARGET)-nx; \
	else \
		readelf -l $(TARGET)-nx | grep -A 1 GNU_STACK || echo "No GNU_STACK segment"; \
	fi

# Analyze the binary for ROP gadgets
gadgets: $(TARGET)-nx
	@echo "[*] Searching for ROP gadgets in $(TARGET)-nx..."
	@if command -v ROPgadget > /dev/null 2>&1; then \
		ROPgadget --binary $(TARGET)-nx | head -50; \
	elif command -v ropper > /dev/null 2>&1; then \
		ropper --file $(TARGET)-nx --search "pop rdi"; \
		ropper --file $(TARGET)-nx --search "pop rsi"; \
		ropper --file $(TARGET)-nx --search "syscall"; \
	else \
		echo "[!] Install ROPgadget or ropper for gadget analysis"; \
		echo "    pip3 install ROPgadget"; \
		echo "    pip3 install ropper"; \
		objdump -d $(TARGET)-nx | grep -E "(pop|ret|syscall)"; \
	fi

# Generate exploit payload
exploit: $(TARGET)-nx
	@echo "[*] Generating exploit payload..."
	@chmod +x exploit.py
	@python3 exploit.py $(TARGET)-nx

# Test the exploit (this will crash the program)
test-exploit: $(TARGET)-nx exploit
	@echo "[*] Testing exploit (this will cause a segmentation fault)..."
	@echo "[!] Running vulnerable service with payload..."
	@-./$(TARGET)-nx "$$(cat exploit_payload.bin)" 2>&1 || true
	@echo ""
	@echo "[*] Program crashed as expected!"

# Run the vulnerable service interactively
run: $(TARGET)
	@./$(TARGET)

# Run with NX protection
run-nx: $(TARGET)-nx
	@./$(TARGET)-nx

# Show disassembly of vulnerable function
disasm: $(TARGET)-nx
	@echo "[*] Disassembly of process_command function:"
	@objdump -d $(TARGET)-nx | grep -A 50 "<process_command>:" | head -60

# Show all symbols
symbols: $(TARGET)-nx
	@echo "[*] Symbol table:"
	@nm $(TARGET)-nx

# Clean build artifacts
clean:
	@echo "[*] Cleaning..."
	@rm -f $(TARGET) $(TARGET)-nx *.o exploit_payload.bin core
	@echo "[+] Clean complete"

# Install ROPgadget tool (requires pip)
install-tools:
	@echo "[*] Installing ROP analysis tools..."
	@pip3 install --user ROPgadget ropper
	@echo "[+] Tools installed"

# Show help
help:
	@echo "ROP Exploit Demo Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  make              - Build both versions of vulnerable binary"
	@echo "  make check        - Check security features of binaries"
	@echo "  make gadgets      - Search for ROP gadgets"
	@echo "  make exploit      - Generate exploit payload"
	@echo "  make test-exploit - Test the exploit (will crash)"
	@echo "  make run          - Run vulnerable service (executable stack)"
	@echo "  make run-nx       - Run vulnerable service (NX protected)"
	@echo "  make disasm       - Show disassembly of vulnerable function"
	@echo "  make symbols      - Show symbol table"
	@echo "  make install-tools- Install ROP analysis tools"
	@echo "  make clean        - Clean build artifacts"
	@echo "  make help         - Show this help"
	@echo ""
	@echo "Examples:"
	@echo "  make && make exploit        - Build and create exploit"
	@echo "  make check                  - Verify security features"
	@echo "  make gadgets                - Find ROP gadgets"
	@echo "  make test-exploit           - Test the exploit"

.PHONY: all check gadgets exploit test-exploit run run-nx disasm symbols clean install-tools help
