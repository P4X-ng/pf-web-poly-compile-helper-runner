/*
 * Vulnerable Legacy Service - Simulates an old piece of software
 * 
 * This program simulates a legacy network service with multiple vulnerabilities:
 * - Stack-based buffer overflow in process_command()
 * - No stack canaries (compiled with -fno-stack-protector)
 * - No ASLR/PIE for demonstration purposes
 * 
 * Vulnerability: Buffer overflow in command processing
 * Attack vector: ROP chain to bypass NX bit and execute shellcode
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// Simulated old-style logging function
void log_message(const char *msg) {
    printf("[LOG] %s\n", msg);
}

// Simulated authentication (always fails, for demo)
int authenticate(const char *user, const char *pass) {
    log_message("Authentication attempt");
    return 0; // Always fail
}

// A gadget function - contains useful ROP gadgets
void gadget_function() {
    __asm__(
        "pop %rdi\n"
        "ret\n"
    );
}

// Another gadget - pop multiple registers
void gadget_pop_rsi_r15() {
    __asm__(
        "pop %rsi\n"
        "pop %r15\n"
        "ret\n"
    );
}

// System call wrapper - useful for ROP
void syscall_wrapper() {
    __asm__("syscall\n");
}

// Vulnerable function - buffer overflow here
void process_command(char *input) {
    char buffer[128];  // Small buffer
    
    log_message("Processing command");
    
    // VULNERABLE: No bounds checking!
    // This strcpy allows buffer overflow
    strcpy(buffer, input);
    
    // Simulate some command processing
    if (strncmp(buffer, "HELP", 4) == 0) {
        printf("Commands: HELP, STATUS, QUIT\n");
    } else if (strncmp(buffer, "STATUS", 6) == 0) {
        printf("Service running normally\n");
    } else if (strncmp(buffer, "QUIT", 4) == 0) {
        printf("Goodbye\n");
        exit(0);
    } else {
        printf("Unknown command: %s\n", buffer);
    }
}

// Main service loop
int main(int argc, char *argv[]) {
    char input[1024];
    
    printf("==============================================\n");
    printf("  Legacy Service v1.0 (Vulnerable Demo)      \n");
    printf("==============================================\n");
    printf("This service simulates old software with     \n");
    printf("known vulnerabilities for educational purposes\n");
    printf("----------------------------------------------\n\n");
    
    // Check if input is provided as argument
    if (argc > 1) {
        // Process command from argument
        strncpy(input, argv[1], sizeof(input) - 1);
        input[sizeof(input) - 1] = '\0';
        process_command(input);
        return 0;
    }
    
    // Interactive mode
    while (1) {
        printf("cmd> ");
        fflush(stdout);
        
        if (fgets(input, sizeof(input), stdin) == NULL) {
            break;
        }
        
        // Remove newline
        input[strcspn(input, "\n")] = 0;
        
        if (strlen(input) == 0) {
            continue;
        }
        
        process_command(input);
    }
    
    return 0;
}
