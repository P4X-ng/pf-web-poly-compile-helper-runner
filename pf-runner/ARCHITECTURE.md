# pf-runner Architecture

## Code Organization

The pf-runner codebase is organized into focused modules with clear responsibilities:

### Core Modules

| Module | Lines | Description | Status |
|--------|-------|-------------|--------|
| `pf_main.py` | 580 | Main entry point and CLI orchestration | Active |
| `pf_parser.py` | 1939 | DSL parsing, task management, and polyglot execution | Active |
| `pf_grammar.py` | 3558 | **Auto-generated** Lark parser (DO NOT EDIT) | Generated |
| `pf_lark_parser.py` | - | Lark-based alternative parser | Active |
| `pf_exceptions.py` | - | Custom exception types | Active |
| `pf_args.py` | - | Argument parsing utilities | Active |

### Feature Modules

| Module | Lines | Description | Status |
|--------|-------|-------------|--------|
| `pf_tui.py` | 1279 | Rich-based TUI for interactive task browsing | Active |
| `pf_containerize.py` | 1267 | Auto-containerization with Docker/Podman | Active |
| `pf_prune.py` | 625 | Syntax checking and validation | Active |
| `pf_shell.py` | - | Shell validation utilities | Active |
| `pf_api.py` | - | REST API server | Active |

### Support Infrastructure

| Module | Lines | Description |
|--------|-------|-------------|
| `pf.lark` | - | Grammar definition for Lark parser (source file) |
| `pyproject.toml` | - | Project configuration and dependencies |
| `Makefile` | - | Build and installation automation |

## Auto-Generated Files

âš ï¸ **IMPORTANT**: Some files are automatically generated and should **NOT** be manually edited:

### pf_grammar.py (3558 lines)

This file is generated by the Lark stand-alone parser generator from `pf.lark`:

```python
# The file was automatically generated by Lark v1.3.0
```

**DO NOT REFACTOR OR EDIT THIS FILE MANUALLY**

- Generated from: `pf.lark`
- Generator: Lark v1.3.0 stand-alone parser tool
- License: Mozilla Public License v2.0 (separate from main project)
- Purpose: Standalone LALR(1) parser for the pf DSL

To modify the grammar:
1. Edit `pf.lark` (the source grammar file)
2. Regenerate `pf_grammar.py` using Lark's generator tool
3. Do not manually edit the generated file

## Module Responsibilities

### pf_parser.py (1939 lines)

**Primary responsibilities:**
- Parse Pfyfile.pf and included files
- Task definition and management
- Parameter interpolation
- Polyglot shell command generation (40+ languages)
- Build system helpers (Make, CMake, Cargo, etc.)
- SSH connection management

**Key components:**
- `Task` class: Task definition with metadata
- Pfyfile discovery and loading
- Include file processing
- Polyglot language templates
- Build system detection and execution

### pf_tui.py (1279 lines)

**Primary responsibilities:**
- Interactive terminal UI using Rich library
- Task browsing and execution
- Syntax validation
- File and task navigation
- Visual debugging integration

**Key components:**
- `PfTUI` class: Main TUI controller
- `TaskCategory` and `PfyFile` data classes
- Keyboard navigation
- Task execution with live output

### pf_containerize.py (1267 lines)

**Primary responsibilities:**
- Project language and build system detection
- Automatic Dockerfile generation
- Build retry logic with error pattern matching
- Quadlet file generation for systemd

**Key components:**
- `ProjectDetector` class: Heuristic-based project analysis
- `DockerfileGenerator` class: Smart Dockerfile creation
- `QuadletGenerator` class: Systemd integration
- `ContainerBuilder` class: Build execution and retry

### pf_prune.py (625 lines)

**Primary responsibilities:**
- Syntax validation for pf files
- Debug mode management
- Error reporting with context
- Failed task isolation

**Key components:**
- `PfSyntaxChecker` class: Validation engine
- `SyntaxError` data class: Error representation
- Debug configuration management

## Design Principles

### 1. Minimal Dependencies
- Core functionality uses only standard library
- Optional features have isolated dependencies (Rich, FastAPI, etc.)
- Fabric for SSH is the only required external dependency

### 2. Single-File Capable
- `pf_parser.py` can run standalone
- Other modules are optional enhancements

### 3. Polyglot Support
- Inline code execution for 40+ languages
- Template-based approach
- Fallback to standard shell

### 4. Flexible CLI
- Multiple argument formats (classic `--arg` and legacy `arg=value`)
- Order-independent arguments
- HELP_VARIATIONS for typo tolerance

## File Size Guidelines

Based on the code cleanliness review, we aim to keep files under 500 lines where practical. Files exceeding this threshold should be evaluated for refactoring opportunities:

- âœ… Under 500 lines: Ideal
- âš ï¸ 500-1000 lines: Review for refactoring opportunities
- ðŸ”´ Over 1000 lines: Strong candidate for modularization

**Exception**: Auto-generated files like `pf_grammar.py` are excluded from this guideline.

## Contributing

When adding new features:

1. **Choose the right module**: Add features to the module with related responsibilities
2. **Consider creating new modules**: If a feature is substantial (>200 lines), create a new module
3. **Maintain backward compatibility**: Keep existing APIs stable
4. **Document auto-generated files**: Clearly mark any generated code
5. **Follow the DSL philosophy**: Symbol-free, intuitive verbs

## Testing

Test infrastructure:
- `test_all_pf_tasks.py` - Comprehensive task validation
- `tests/` directory - Organized test suites
- `run_tests.sh` - Test runner script

## Build and Installation

Use the Makefile for common operations:
```bash
make setup              # Local development setup
make install-local      # Install to ~/.local/bin
make build              # Create static executable
make install            # System-wide installation
```

See the main [README.md](README.md) for complete installation instructions.
