# Pfyfile.tests.pf - Testing tasks

task test-basic
  describe Test basic pf.py functionality
  shell ./pf.py list
  shell ./pf.py test_echo test_param=testing
  shell ./pf.py test_params param1=hello param2=world
end

task test-integration
  describe Run integration tests with real commands
  shell ./pf.py update
  shell echo "Integration tests completed successfully"
end

task test-docs
  describe Test all examples from documentation
  shell ./pf.py bootstrap
  shell echo "Documentation examples tested"
end
task test-shells
  describe Verify shell runners and a few languages
  shell [lang:bash] echo "bash ok"
  shell [lang:zsh]  print -l "zsh ok"
  shell [lang:fish] echo fish_ok
  shell [lang:sh]   echo sh_ok
  shell [lang:dash] echo dash_ok
  shell [lang:pwsh] Write-Output 'pwsh ok'
  shell [lang:python] print("py ok")
  shell [lang:node] console.log("node ok")
  shell [lang:perl] print "perl ok\n"
  shell [lang:php]  echo "php ok\n";
  shell [lang:ruby] puts "ruby ok"
  shell [lang:r]    cat("r ok\n")
  shell [lang:julia] println("julia ok")
  shell [lang:lua]  print("lua ok")
end

task test-sync-local
  describe Test local sync functionality with rsync
  shell mkdir -p /tmp/pf_sync_test_src /tmp/pf_sync_test_dest
  shell echo "test file 1" > /tmp/pf_sync_test_src/file1.txt
  shell echo "test file 2" > /tmp/pf_sync_test_src/file2.txt
  shell mkdir -p /tmp/pf_sync_test_src/subdir
  shell echo "test file 3" > /tmp/pf_sync_test_src/subdir/file3.txt
  sync src="/tmp/pf_sync_test_src/" dest="/tmp/pf_sync_test_dest/" verbose
  shell test -f /tmp/pf_sync_test_dest/file1.txt && echo "✓ file1.txt synced"
  shell test -f /tmp/pf_sync_test_dest/file2.txt && echo "✓ file2.txt synced"
  shell test -f /tmp/pf_sync_test_dest/subdir/file3.txt && echo "✓ subdir/file3.txt synced"
  shell rm -rf /tmp/pf_sync_test_src /tmp/pf_sync_test_dest
  shell echo "Local sync test passed!"
end

task test-sync-excludes
  describe Test sync with exclude patterns
  shell mkdir -p /tmp/pf_sync_excl_src /tmp/pf_sync_excl_dest
  shell echo "include me" > /tmp/pf_sync_excl_src/include.txt
  shell echo "exclude me" > /tmp/pf_sync_excl_src/exclude.log
  shell echo "exclude me too" > /tmp/pf_sync_excl_src/temp.tmp
  sync src="/tmp/pf_sync_excl_src/" dest="/tmp/pf_sync_excl_dest/" excludes=["*.log","*.tmp"] verbose
  shell test -f /tmp/pf_sync_excl_dest/include.txt && echo "✓ include.txt synced"
  shell test ! -f /tmp/pf_sync_excl_dest/exclude.log && echo "✓ exclude.log excluded"
  shell test ! -f /tmp/pf_sync_excl_dest/temp.tmp && echo "✓ temp.tmp excluded"
  shell rm -rf /tmp/pf_sync_excl_src /tmp/pf_sync_excl_dest
  shell echo "Exclude patterns test passed!"
end

task test-sync-dry
  describe Test sync dry-run mode
  shell mkdir -p /tmp/pf_sync_dry_src /tmp/pf_sync_dry_dest
  shell echo "dry run test" > /tmp/pf_sync_dry_src/test.txt
  sync src="/tmp/pf_sync_dry_src/" dest="/tmp/pf_sync_dry_dest/" dry verbose
  shell test ! -f /tmp/pf_sync_dry_dest/test.txt && echo "✓ Dry run did not copy files"
  shell rm -rf /tmp/pf_sync_dry_src /tmp/pf_sync_dry_dest
  shell echo "Dry run test passed!"
end

task test-sync-all
  describe Run all sync tests
  shell echo "Running sync tests..."
  shell ./pf test-sync-local
  shell ./pf test-sync-excludes
  shell ./pf test-sync-dry
  shell ./pf test-sync-vars
  shell ./pf test-sync-exclude-file
  shell echo "All sync tests passed!"
end

task test-sync-vars
  describe Test sync with variable interpolation
  env TEST_SRC="/tmp/pf_sync_vars_src"
  env TEST_DEST="/tmp/pf_sync_vars_dest"
  shell mkdir -p $TEST_SRC $TEST_DEST
  shell echo "var test" > $TEST_SRC/vartest.txt
  sync src="$TEST_SRC/" dest="$TEST_DEST/" verbose
  shell test -f $TEST_DEST/vartest.txt && echo "✓ Variable interpolation works"
  shell rm -rf $TEST_SRC $TEST_DEST
  shell echo "Variable interpolation test passed!"
end

task test-sync-exclude-file
  describe Test sync with exclude file
  shell mkdir -p /tmp/pf_sync_exf_src /tmp/pf_sync_exf_dest
  shell echo "include this" > /tmp/pf_sync_exf_src/include.txt
  shell echo "exclude this" > /tmp/pf_sync_exf_src/exclude.bak
  shell echo "exclude too" > /tmp/pf_sync_exf_src/temp.cache
  shell echo "*.bak" > /tmp/pf_sync_exclude.txt
  shell echo "*.cache" >> /tmp/pf_sync_exclude.txt
  sync src="/tmp/pf_sync_exf_src/" dest="/tmp/pf_sync_exf_dest/" exclude_file="/tmp/pf_sync_exclude.txt" verbose
  shell test -f /tmp/pf_sync_exf_dest/include.txt && echo "✓ include.txt synced"
  shell test ! -f /tmp/pf_sync_exf_dest/exclude.bak && echo "✓ exclude.bak excluded via file"
  shell test ! -f /tmp/pf_sync_exf_dest/temp.cache && echo "✓ temp.cache excluded via file"
  shell rm -rf /tmp/pf_sync_exf_src /tmp/pf_sync_exf_dest /tmp/pf_sync_exclude.txt
  shell echo "Exclude file test passed!"
end
