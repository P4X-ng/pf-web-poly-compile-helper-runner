/*
 * Vulnerable Demo Binary for Exploit Development Testing
 * 
 * This program contains intentional vulnerabilities for educational purposes.
 * DO NOT use this code in production systems.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// Vulnerable function with buffer overflow
void vulnerable_function(char *input) {
    char buffer[64];
    
    printf("Input received: %s\n", input);
    
    // VULNERABILITY: No bounds checking - buffer overflow possible
    strcpy(buffer, input);
    
    printf("Buffer contents: %s\n", buffer);
}

// Function with format string vulnerability
void format_string_vuln(char *input) {
    // VULNERABILITY: User input used directly in printf
    printf(input);
    printf("\n");
}

// Function that might be useful for ROP
void useful_function() {
    printf("This is a useful function for ROP chains\n");
}

// Another useful function
void print_flag() {
    printf("FLAG{demo_exploit_successful}\n");
}

// System function wrapper (useful for ret2libc)
void call_system(char *cmd) {
    system(cmd);
}

int main(int argc, char *argv[]) {
    char input[256];
    
    printf("=== Vulnerable Demo Program ===\n");
    printf("This program contains intentional vulnerabilities for testing.\n");
    printf("Choose an option:\n");
    printf("1. Buffer overflow test\n");
    printf("2. Format string test\n");
    printf("3. Interactive mode\n");
    printf("Choice: ");
    
    if (argc > 1) {
        // Command line argument mode
        int choice = atoi(argv[1]);
        
        switch (choice) {
            case 1:
                printf("Buffer overflow test mode\n");
                if (argc > 2) {
                    vulnerable_function(argv[2]);
                } else {
                    printf("Usage: %s 1 <input_string>\n", argv[0]);
                }
                break;
                
            case 2:
                printf("Format string test mode\n");
                if (argc > 2) {
                    format_string_vuln(argv[2]);
                } else {
                    printf("Usage: %s 2 <format_string>\n", argv[0]);
                }
                break;
                
            default:
                printf("Invalid choice\n");
                break;
        }
    } else {
        // Interactive mode
        int choice;
        scanf("%d", &choice);
        
        switch (choice) {
            case 1:
                printf("Enter input for buffer overflow test: ");
                fgets(input, sizeof(input), stdin);
                input[strcspn(input, "\n")] = 0; // Remove newline
                vulnerable_function(input);
                break;
                
            case 2:
                printf("Enter format string: ");
                fgets(input, sizeof(input), stdin);
                input[strcspn(input, "\n")] = 0; // Remove newline
                format_string_vuln(input);
                break;
                
            case 3:
                printf("Interactive mode - enter commands:\n");
                while (1) {
                    printf("> ");
                    if (fgets(input, sizeof(input), stdin) == NULL) break;
                    input[strcspn(input, "\n")] = 0; // Remove newline
                    
                    if (strcmp(input, "quit") == 0) break;
                    if (strcmp(input, "flag") == 0) {
                        print_flag();
                        continue;
                    }
                    if (strncmp(input, "system ", 7) == 0) {
                        call_system(input + 7);
                        continue;
                    }
                    
                    // Default: treat as buffer overflow input
                    vulnerable_function(input);
                }
                break;
                
            default:
                printf("Invalid choice\n");
                break;
        }
    }
    
    printf("Program finished.\n");
    return 0;
}

/*
 * Compilation instructions for different security levels:
 * 
 * Most vulnerable (no protections):
 * gcc -o vuln_demo -fno-stack-protector -z execstack -no-pie vulnerable.c
 * 
 * Some protections:
 * gcc -o vuln_demo -fstack-protector -z noexecstack vulnerable.c
 * 
 * Most protections (for advanced exploitation):
 * gcc -o vuln_demo -fstack-protector-all -D_FORTIFY_SOURCE=2 -Wl,-z,relro,-z,now -fPIE -pie vulnerable.c
 * 
 * Testing:
 * 1. Buffer overflow: ./vuln_demo 1 $(python3 -c "print('A'*100)")
 * 2. Format string: ./vuln_demo 2 "%x.%x.%x.%x"
 * 3. Interactive: ./vuln_demo 3
 */