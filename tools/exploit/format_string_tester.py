#!/usr/bin/env python3
"""
Format String Vulnerability Tester
Tests a binary for format string vulnerabilities
"""

import sys
import os
import subprocess

def test_format_string(binary_path, input_method='stdin'):
    """Test binary for format string vulnerabilities"""
    
    print(f"Testing {binary_path} for format string vulnerabilities...")
    print(f"Input method: {input_method}\n")
    
    # Test patterns that reveal format string vulnerabilities
    test_patterns = [
        "%x",           # Read from stack
        "%s",           # Read string from stack (may crash)
        "%p",           # Read pointer
        "%x.%x.%x",     # Multiple reads
        "%10$p",        # Direct parameter access
        "AAAA%p",       # Marker + pointer
        "AAAA%10$p",    # Marker + direct access
    ]
    
    print("Test patterns:")
    for i, pattern in enumerate(test_patterns, 1):
        print(f"  {i}. {pattern}")
    
    print("\nRunning tests...")
    print("=" * 60)
    
    results = []
    for pattern in test_patterns:
        print(f"\nTesting: {pattern}")
        try:
            if input_method == 'stdin':
                result = subprocess.run(
                    [binary_path],
                    input=pattern.encode(),
                    capture_output=True,
                    timeout=2
                )
            elif input_method == 'argv':
                result = subprocess.run(
                    [binary_path, pattern],
                    capture_output=True,
                    timeout=2
                )
            else:
                print(f"Unknown input method: {input_method}")
                continue
            
            output = result.stdout.decode('utf-8', errors='ignore')
            error = result.stderr.decode('utf-8', errors='ignore')
            
            # Check for format string vulnerability indicators
            vulnerable = False
            if pattern in output:
                # If we see our input echoed back, not vulnerable (just echo)
                if pattern.replace('%', '') in output:
                    vulnerable = False
            elif any(indicator in output for indicator in ['0x', 'nil', '(null)']):
                vulnerable = True
            
            results.append({
                'pattern': pattern,
                'vulnerable': vulnerable,
                'output': output[:200],
                'returncode': result.returncode
            })
            
            print(f"  Return code: {result.returncode}")
            if output:
                print(f"  Output: {output[:100]}")
            if vulnerable:
                print(f"  ⚠️  Possible format string vulnerability detected!")
            
        except subprocess.TimeoutExpired:
            print(f"  ⚠️  Process timeout - possible crash or hang")
            results.append({
                'pattern': pattern,
                'vulnerable': True,
                'output': 'TIMEOUT',
                'returncode': -1
            })
        except Exception as e:
            print(f"  Error: {e}")
    
    print("\n" + "=" * 60)
    print("\nSummary:")
    vulnerable_count = sum(1 for r in results if r['vulnerable'])
    print(f"  Total tests: {len(results)}")
    print(f"  Potentially vulnerable: {vulnerable_count}")
    
    if vulnerable_count > 0:
        print(f"\n⚠️  This binary may be vulnerable to format string attacks!")
        print(f"\nNext steps:")
        print(f"  1. Generate exploit template: pf format-string-exploit binary={binary_path}")
        print(f"  2. Use pwntools to develop a working exploit")
    else:
        print(f"\n✓ No obvious format string vulnerabilities detected")

def main():
    if len(sys.argv) < 2:
        print("Usage: format_string_tester.py <binary> [input_method]")
        print("  input_method: stdin (default) or argv")
        print("Example: format_string_tester.py vuln_binary stdin")
        sys.exit(1)
    
    binary_path = sys.argv[1]
    input_method = sys.argv[2] if len(sys.argv) > 2 else 'stdin'
    
    if not os.path.exists(binary_path):
        print(f"Error: Binary not found: {binary_path}")
        sys.exit(1)
    
    test_format_string(binary_path, input_method)

if __name__ == '__main__':
    main()
