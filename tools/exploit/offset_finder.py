#!/usr/bin/env python3
"""
Buffer Overflow Offset Finder
Find the offset in a cyclic pattern from crash data
"""

import sys
import argparse

def find_offset(crash_value, pattern_length=300):
    """Find offset in cyclic pattern"""
    
    try:
        from pwn import *
    except ImportError:
        print("❌ Error: pwntools not installed. Run 'pf install-pwntools' first.")
        sys.exit(1)
    
    # Generate cyclic pattern
    pattern = cyclic(pattern_length)
    
    # Handle different input formats
    if isinstance(crash_value, str):
        if crash_value.startswith('0x'):
            # Hex value
            try:
                crash_bytes = p64(int(crash_value, 16))
            except ValueError:
                try:
                    crash_bytes = p32(int(crash_value, 16))
                except ValueError:
                    print(f"❌ Error: Invalid hex value: {crash_value}")
                    return
        else:
            # Try as string
            crash_bytes = crash_value.encode()
    
    # Find offset
    try:
        offset = cyclic_find(crash_bytes)
        if offset != -1:
            print(f"✅ Offset found: {offset}")
            print(f"   Crash value: {crash_value}")
            print(f"   Pattern length: {pattern_length}")
            print()
            print("Usage in exploit:")
            print(f"   payload = b'A' * {offset}")
            print("   payload += p64(return_address)  # or p32() for 32-bit")
            return offset
        else:
            print(f"❌ Offset not found in pattern")
            print(f"   Crash value: {crash_value}")
            print(f"   Pattern length: {pattern_length}")
            print()
            print("Try:")
            print(f"   1. Increase pattern length: pf buffer-overflow-pattern length={pattern_length * 2}")
            print("   2. Check if crash value is correct")
            print("   3. Verify architecture (32-bit vs 64-bit)")
            return None
    except Exception as e:
        print(f"❌ Error finding offset: {e}")
        return None

def generate_pattern_info(length):
    """Generate pattern and show usage info"""
    
    try:
        from pwn import *
    except ImportError:
        print("❌ Error: pwntools not installed. Run 'pf install-pwntools' first.")
        sys.exit(1)
    
    pattern = cyclic(length)
    
    print(f"Cyclic pattern ({length} bytes):")
    print(pattern.decode())
    print()
    print("Usage:")
    print("1. Send this pattern to the vulnerable program")
    print("2. Note the crash value (e.g., from segfault or debugger)")
    print("3. Find offset with: pf buffer-overflow-offset <crash_value>")
    print()
    print("Example crash values:")
    print("   - 0x6161616161616161 (hex from debugger)")
    print("   - aaaaaaaa (string from crash)")
    print("   - 1633771873 (decimal value)")

def main():
    parser = argparse.ArgumentParser(description='Find buffer overflow offset')
    parser.add_argument('crash_value', help='Crash value from segfault (hex, string, or decimal)')
    parser.add_argument('pattern_length', type=int, nargs='?', default=300, help='Length of cyclic pattern used')
    
    args = parser.parse_args()
    
    find_offset(args.crash_value, args.pattern_length)

if __name__ == "__main__":
    main()