#!/usr/bin/env python3
"""
ROPgadget Integration Wrapper
Provides pf task integration for ROPgadget ROP chain automation
"""

import os
import sys
import json
import argparse
import subprocess
from pathlib import Path
from typing import Dict, List, Optional, Union

class ROPgadgetWrapper:
    """Wrapper for ROPgadget functionality"""
    
    def __init__(self):
        self.check_ropgadget()
    
    def check_ropgadget(self):
        """Check if ROPgadget is installed"""
        try:
            result = subprocess.run(['ROPgadget', '--version'], 
                                  capture_output=True, text=True, timeout=5)
            self.ropgadget_available = result.returncode == 0
        except (subprocess.TimeoutExpired, subprocess.SubprocessError, FileNotFoundError):
            self.ropgadget_available = False
    
    def install_ropgadget(self):
        """Install ROPgadget via pip"""
        print("Installing ROPgadget...")
        try:
            subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'ROPgadget'])
            print("✅ ROPgadget installed successfully")
            self.ropgadget_available = True
            return True
        except subprocess.CalledProcessError as e:
            print(f"❌ Failed to install ROPgadget: {e}")
            return False
    
    def find_gadgets(self, binary_path: str, output_file: Optional[str] = None, 
                    gadget_type: Optional[str] = None, depth: int = 10):
        """Find ROP gadgets in binary"""
        if not self.ropgadget_available:
            print("❌ ROPgadget not available. Install with: pf install-ropgadget")
            return False
        
        if not os.path.exists(binary_path):
            print(f"❌ Binary not found: {binary_path}")
            return False
        
        cmd = ['ROPgadget', '--binary', binary_path, '--depth', str(depth)]
        
        if gadget_type:
            if gadget_type == 'rop':
                cmd.extend(['--rop'])
            elif gadget_type == 'jop':
                cmd.extend(['--jop'])
            elif gadget_type == 'sys':
                cmd.extend(['--sys'])
        
        if output_file:
            cmd.extend(['--dump', output_file])
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
            
            if result.returncode != 0:
                print(f"❌ ROPgadget failed: {result.stderr}")
                return False
            
            if output_file:
                print(f"✅ Gadgets saved to: {output_file}")
            else:
                print(result.stdout)
            
            return True
            
        except subprocess.TimeoutExpired:
            print("❌ ROPgadget timed out")
            return False
        except Exception as e:
            print(f"❌ Failed to find gadgets: {e}")
            return False
    
    def search_gadgets(self, binary_path: str, search_term: str, 
                      output_file: Optional[str] = None):
        """Search for specific gadgets"""
        if not self.ropgadget_available:
            print("❌ ROPgadget not available. Install with: pf install-ropgadget")
            return False
        
        if not os.path.exists(binary_path):
            print(f"❌ Binary not found: {binary_path}")
            return False
        
        cmd = ['ROPgadget', '--binary', binary_path, '--string', search_term]
        
        if output_file:
            cmd.extend(['--dump', output_file])
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=15)
            
            if result.returncode != 0:
                print(f"❌ ROPgadget search failed: {result.stderr}")
                return False
            
            if output_file:
                print(f"✅ Search results saved to: {output_file}")
            else:
                print(f"Search results for '{search_term}':")
                print(result.stdout)
            
            return True
            
        except subprocess.TimeoutExpired:
            print("❌ ROPgadget search timed out")
            return False
        except Exception as e:
            print(f"❌ Failed to search gadgets: {e}")
            return False
    
    def build_rop_chain(self, binary_path: str, output_file: Optional[str] = None):
        """Build ROP chain automatically"""
        if not self.ropgadget_available:
            print("❌ ROPgadget not available. Install with: pf install-ropgadget")
            return False
        
        if not os.path.exists(binary_path):
            print(f"❌ Binary not found: {binary_path}")
            return False
        
        cmd = ['ROPgadget', '--binary', binary_path, '--rop']
        
        if output_file:
            # ROPgadget doesn't have direct output for ROP chains, so we capture stdout
            pass
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
            
            if result.returncode != 0:
                print(f"❌ ROP chain generation failed: {result.stderr}")
                return False
            
            if output_file:
                with open(output_file, 'w') as f:
                    f.write(result.stdout)
                print(f"✅ ROP chain saved to: {output_file}")
            else:
                print("Generated ROP chain:")
                print(result.stdout)
            
            return True
            
        except subprocess.TimeoutExpired:
            print("❌ ROP chain generation timed out")
            return False
        except Exception as e:
            print(f"❌ Failed to build ROP chain: {e}")
            return False
    
    def analyze_binary(self, binary_path: str, output_format: str = "table"):
        """Analyze binary for ROP exploitation potential"""
        if not self.ropgadget_available:
            print("❌ ROPgadget not available. Install with: pf install-ropgadget")
            return False
        
        if not os.path.exists(binary_path):
            print(f"❌ Binary not found: {binary_path}")
            return False
        
        # Get basic gadget count
        cmd = ['ROPgadget', '--binary', binary_path, '--depth', '5']
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=20)
            
            if result.returncode != 0:
                print(f"❌ Binary analysis failed: {result.stderr}")
                return False
            
            # Parse output to get gadget statistics
            lines = result.stdout.split('\n')
            gadget_count = 0
            unique_gadgets = 0
            
            for line in lines:
                if 'gadgets found' in line.lower():
                    try:
                        gadget_count = int(line.split()[0])
                    except (ValueError, IndexError):
                        pass
                elif 'unique gadgets found' in line.lower():
                    try:
                        unique_gadgets = int(line.split()[0])
                    except (ValueError, IndexError):
                        pass
            
            analysis = {
                "file": binary_path,
                "total_gadgets": gadget_count,
                "unique_gadgets": unique_gadgets,
                "rop_potential": "High" if gadget_count > 100 else "Medium" if gadget_count > 20 else "Low"
            }
            
            if output_format == "json":
                print(json.dumps(analysis, indent=2))
            else:
                self._print_analysis_table(analysis)
            
            return True
            
        except subprocess.TimeoutExpired:
            print("❌ Binary analysis timed out")
            return False
        except Exception as e:
            print(f"❌ Failed to analyze binary: {e}")
            return False
    
    def _print_analysis_table(self, analysis: Dict):
        """Print analysis information in table format"""
        filename = os.path.basename(analysis["file"])
        print(f"\nROP Exploitation Analysis: {filename}")
        print("=" * (len(filename) + 25))
        print(f"Total Gadgets:     {analysis['total_gadgets']}")
        print(f"Unique Gadgets:    {analysis['unique_gadgets']}")
        print(f"ROP Potential:     {analysis['rop_potential']}")
        
        if analysis['total_gadgets'] > 50:
            print("\n✅ Good ROP exploitation potential")
        elif analysis['total_gadgets'] > 10:
            print("\n⚠️  Limited ROP exploitation potential")
        else:
            print("\n❌ Poor ROP exploitation potential")
    
    def find_specific_gadgets(self, binary_path: str, gadget_patterns: List[str], 
                             output_file: Optional[str] = None):
        """Find specific gadget patterns"""
        if not self.ropgadget_available:
            print("❌ ROPgadget not available. Install with: pf install-ropgadget")
            return False
        
        if not os.path.exists(binary_path):
            print(f"❌ Binary not found: {binary_path}")
            return False
        
        results = {}
        
        for pattern in gadget_patterns:
            cmd = ['ROPgadget', '--binary', binary_path, '--only', pattern]
            
            try:
                result = subprocess.run(cmd, capture_output=True, text=True, timeout=10)
                
                if result.returncode == 0:
                    # Count gadgets found
                    lines = result.stdout.split('\n')
                    gadget_lines = [line for line in lines if ':' in line and 'ret' in line.lower()]
                    results[pattern] = {
                        'count': len(gadget_lines),
                        'gadgets': gadget_lines[:5]  # First 5 gadgets
                    }
                else:
                    results[pattern] = {'count': 0, 'gadgets': []}
                    
            except subprocess.TimeoutExpired:
                results[pattern] = {'count': 0, 'gadgets': [], 'error': 'timeout'}
            except Exception as e:
                results[pattern] = {'count': 0, 'gadgets': [], 'error': str(e)}
        
        # Output results
        if output_file:
            with open(output_file, 'w') as f:
                json.dump(results, f, indent=2)
            print(f"✅ Specific gadget search results saved to: {output_file}")
        else:
            print("Specific Gadget Search Results:")
            print("=" * 35)
            for pattern, data in results.items():
                print(f"\n{pattern}: {data['count']} gadgets found")
                if data['gadgets']:
                    for gadget in data['gadgets']:
                        print(f"  {gadget}")
                if 'error' in data:
                    print(f"  Error: {data['error']}")
        
        return True

def main():
    parser = argparse.ArgumentParser(
        description="ROPgadget integration wrapper",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s --install                           # Install ROPgadget
  %(prog)s --find-gadgets ./binary             # Find all gadgets
  %(prog)s --find-gadgets ./binary --output gadgets.txt
  %(prog)s --search ./binary "pop rdi"        # Search for specific gadgets
  %(prog)s --build-chain ./binary             # Build ROP chain
  %(prog)s --analyze ./binary                  # Analyze ROP potential
  %(prog)s --specific ./binary "pop rdi,pop rsi,pop rdx"
        """
    )
    
    parser.add_argument("--install", action="store_true", help="Install ROPgadget")
    parser.add_argument("--find-gadgets", metavar="BINARY", help="Find ROP gadgets in binary")
    parser.add_argument("--search", metavar="BINARY", help="Search for specific gadgets")
    parser.add_argument("--search-term", metavar="TERM", help="Search term for gadgets")
    parser.add_argument("--build-chain", metavar="BINARY", help="Build ROP chain")
    parser.add_argument("--analyze", metavar="BINARY", help="Analyze ROP exploitation potential")
    parser.add_argument("--specific", metavar="BINARY", help="Find specific gadget patterns")
    parser.add_argument("--patterns", metavar="PATTERNS", help="Comma-separated gadget patterns")
    parser.add_argument("--output", metavar="FILE", help="Output file")
    parser.add_argument("--json", action="store_true", help="Output in JSON format")
    parser.add_argument("--depth", metavar="N", type=int, default=10, help="Gadget search depth")
    parser.add_argument("--type", metavar="TYPE", choices=['rop', 'jop', 'sys'], help="Gadget type")
    
    args = parser.parse_args()
    
    wrapper = ROPgadgetWrapper()
    
    if args.install:
        wrapper.install_ropgadget()
    elif args.find_gadgets:
        wrapper.find_gadgets(args.find_gadgets, args.output, args.type, args.depth)
    elif args.search:
        if not args.search_term:
            print("Error: --search-term required with --search")
            sys.exit(1)
        wrapper.search_gadgets(args.search, args.search_term, args.output)
    elif args.build_chain:
        wrapper.build_rop_chain(args.build_chain, args.output)
    elif args.analyze:
        output_format = "json" if args.json else "table"
        wrapper.analyze_binary(args.analyze, output_format)
    elif args.specific:
        if not args.patterns:
            print("Error: --patterns required with --specific")
            sys.exit(1)
        patterns = [p.strip() for p in args.patterns.split(',')]
        wrapper.find_specific_gadgets(args.specific, patterns, args.output)
    else:
        parser.print_help()

if __name__ == "__main__":
    main()